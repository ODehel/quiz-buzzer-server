<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Logique de Jeu QuizBuzzer</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        h2 { 
            color: #555; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        input, select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            margin-top: 20px;
            height: 400px;
            overflow-y: scroll;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-radius: 4px;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-info { color: #9cdcfe; }
        .log-time { color: #808080; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .stat-card h3 { margin: 0 0 10px 0; color: #007bff; font-size: 16px; }
        .stat-card p { margin: 5px 0; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table th { background: #007bff; color: white; }
        table tr:hover { background: #f5f5f5; }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Test de la Logique de Jeu QuizBuzzer</h1>

        <!-- Section 1 : Cr√©er une partie -->
        <h2>1Ô∏è‚É£ Cr√©er une partie</h2>
        <div class="section">
            <input type="text" id="gameName" placeholder="Nom de la partie" value="Partie Test">
            <button class="btn-primary" onclick="loadQuestions()">üìã Charger les questions</button>
            <button class="btn-success" onclick="createGame()">üéØ Cr√©er la partie</button>
            <div id="questionSelection" style="margin-top: 10px;"></div>
        </div>

        <!-- Section 2 : Ajouter des joueurs -->
        <h2>2Ô∏è‚É£ Ajouter des joueurs</h2>
        <div class="section">
            <input type="text" id="buzzerID" placeholder="Buzzer ID (ex: BUZZ_001)" value="BUZZ_001">
            <input type="text" id="playerName" placeholder="Nom du joueur (ex: Alice)" value="Alice">
            <button class="btn-primary" onclick="addPlayer()">‚ûï Ajouter joueur</button>
            <button class="btn-secondary" onclick="addMultiplePlayers()">üë• Ajouter 3 joueurs de test</button>
        </div>

        <!-- Section 3 : Contr√¥le de la partie -->
        <h2>3Ô∏è‚É£ Contr√¥le de la partie</h2>
        <div class="section">
            <button class="btn-success" onclick="startGame()">‚ñ∂Ô∏è D√©marrer la partie</button>
            <button class="btn-primary" onclick="getCurrentQuestion()">üìù Voir question actuelle</button>
            <button class="btn-warning" onclick="simulateAnswers()">üí° Simuler des r√©ponses</button>
            <button class="btn-primary" onclick="nextQuestion()">‚è≠Ô∏è Question suivante</button>
            <button class="btn-danger" onclick="endGame()">‚èπÔ∏è Terminer la partie</button>
        </div>

        <!-- Section 4 : R√©sultats -->
        <h2>4Ô∏è‚É£ R√©sultats et Statistiques</h2>
        <div class="section">
            <button class="btn-primary" onclick="getRanking()">üèÜ Afficher le classement</button>
            <button class="btn-primary" onclick="getStats()">üìä Afficher les statistiques</button>
            <button class="btn-primary" onclick="getGameInfo()">‚ÑπÔ∏è Informations de la partie</button>
        </div>

        <div id="results" class="stats-grid"></div>

        <!-- Section 5 : Tests automatis√©s -->
        <h2>5Ô∏è‚É£ Tests automatis√©s</h2>
        <div class="section">
            <button class="btn-success" onclick="runFullTest()">üöÄ Lancer test complet</button>
            <button class="btn-warning" onclick="clearLog()">üóëÔ∏è Effacer les logs</button>
        </div>

        <!-- Logs -->
        <h2>üìã Logs</h2>
        <div id="log"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let currentGameId = null;
        let allQuestions = [];
        let selectedQuestionIds = [];

        // Logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const colors = {
                success: 'log-success',
                error: 'log-error',
                info: 'log-info'
            };
            logDiv.innerHTML += `<div><span class="log-time">[${time}]</span> <span class="${colors[type]}">${message}</span></div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Logs effac√©s', 'info');
        }

        // 1. Charger les questions disponibles
        async function loadQuestions() {
            try {
                const response = await fetch(`${API_URL}/questions`);
                allQuestions = await response.json();
                
                const container = document.getElementById('questionSelection');
                container.innerHTML = '<h4>S√©lectionnez les questions :</h4>';
                
                allQuestions.forEach(q => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `q_${q.id}`;
                    checkbox.value = q.id;
                    checkbox.checked = true;
                    
                    const label = document.createElement('label');
                    label.htmlFor = `q_${q.id}`;
                    label.innerHTML = ` ${q.text} <span class="badge ${q.type === 'MCQ' ? 'badge-success' : 'badge-danger'}">${q.type}</span><br>`;
                    
                    container.appendChild(checkbox);
                    container.appendChild(label);
                });
                
                log(`‚úÖ ${allQuestions.length} questions charg√©es`, 'success');
            } catch (error) {
                log(`‚ùå Erreur chargement questions: ${error.message}`, 'error');
            }
        }

        // 2. Cr√©er une partie
        async function createGame() {
            try {
                const name = document.getElementById('gameName').value;
                
                // R√©cup√©rer les questions s√©lectionn√©es
                selectedQuestionIds = allQuestions
                    .filter(q => document.getElementById(`q_${q.id}`).checked)
                    .map(q => q.id);

                if (selectedQuestionIds.length === 0) {
                    log('‚ùå S√©lectionnez au moins une question', 'error');
                    return;
                }

                const response = await fetch(`${API_URL}/games`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        questionIds: selectedQuestionIds,
                        settings: {
                            mcqDuration: 30000,
                            buzzerDuration: 10000
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentGameId = data.id;
                    log(`‚úÖ Partie cr√©√©e : ${data.name} (ID: ${data.id})`, 'success');
                    log(`üìä ${data.questionCount} questions dans cette partie`, 'info');
                } else {
                    log(`‚ùå Erreur : ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // 3. Ajouter un joueur
        async function addPlayer() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                const buzzerID = document.getElementById('buzzerID').value;
                const playerName = document.getElementById('playerName').value;

                const response = await fetch(`${API_URL}/games/${currentGameId}/players`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ buzzerID, playerName })
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Joueur ajout√© : ${playerName} (${buzzerID})`, 'success');
                } else {
                    log(`‚ùå Erreur : ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // Ajouter plusieurs joueurs de test
        async function addMultiplePlayers() {
            const players = [
                { buzzerID: 'BUZZ_001', playerName: 'Alice' },
                { buzzerID: 'BUZZ_002', playerName: 'Bob' },
                { buzzerID: 'BUZZ_003', playerName: 'Charlie' }
            ];

            for (const player of players) {
                document.getElementById('buzzerID').value = player.buzzerID;
                document.getElementById('playerName').value = player.playerName;
                await addPlayer();
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        // 4. D√©marrer la partie
        async function startGame() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/games/${currentGameId}/start`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Partie d√©marr√©e √† ${new Date(data.startedAt).toLocaleTimeString()}`, 'success');
                } else {
                    log(`‚ùå Erreur : ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // 5. Obtenir la question actuelle
        async function getCurrentQuestion() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/games/${currentGameId}/current-question`);
                const question = await response.json();
                
                if (response.ok) {
                    log(`üìù Question actuelle : ${question.text}`, 'info');
                    log(`   Type: ${question.type}, Cat√©gorie: ${question.category}`, 'info');
                    if (question.answers) {
                        log(`   R√©ponses: ${question.answers.join(', ')}`, 'info');
                    }
                } else {
                    log(`‚ùå ${question.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // 6. Simuler des r√©ponses
        async function simulateAnswers() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                // R√©cup√©rer la question actuelle
                const qResponse = await fetch(`${API_URL}/games/${currentGameId}/current-question`);
                const question = await qResponse.json();

                if (!qResponse.ok) {
                    log(`‚ùå ${question.error}`, 'error');
                    return;
                }

                // Simuler des r√©ponses de 3 joueurs
                const players = ['BUZZ_001', 'BUZZ_002', 'BUZZ_003'];
                const now = Date.now();

                for (let i = 0; i < players.length; i++) {
                    const buzzerID = players[i];
                    const answer = question.type === 'MCQ' ? Math.floor(Math.random() * 4) : 0;
                    const responseTime = 1000 + Math.random() * 5000; // Entre 1 et 6 secondes

                    const timestamps = {
                        timestamp_local_action: now + responseTime - 100,
                        timestamp_synced_action: now + responseTime,
                        timestamp_local_send: now + responseTime + 10,
                        calibrated_latency: 20 + Math.random() * 30 // 20-50ms
                    };

                    const response = await fetch(`${API_URL}/games/${currentGameId}/answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            questionId: question.id,
                            buzzerID,
                            answer,
                            timestamps
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        const icon = data.isCorrect ? '‚úÖ' : '‚ùå';
                        log(`${icon} ${buzzerID} a r√©pondu en ${Math.round(responseTime)}ms : ${data.isCorrect ? 'CORRECT' : 'INCORRECT'} (+${data.points} pts)`, data.isCorrect ? 'success' : 'error');
                    }

                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            } catch (error) {
                log(`‚ùå Erreur : ${error.message}`, 'error');
            }
        }

        // 7. Passer √† la question suivante
        async function nextQuestion() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/games/${currentGameId}/next-question`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (response.ok) {
                    if (data.status === 'ended') {
                        log('üèÅ Partie termin√©e ! Toutes les questions ont √©t√© pos√©es.', 'success');
                    } else {
                        log(`‚è≠Ô∏è Prochaine question : ${data.question.text}`, 'info');
                    }
                } else {
                    log(`‚ùå Erreur : ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // 8. Obtenir le classement
        async function getRanking() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/games/${currentGameId}/ranking`);
                const ranking = await response.json();
                
                log('üèÜ Classement actuel :', 'success');
                
                const resultsDiv = document.getElementById('results');
                let tableHTML = '<table><tr><th>Rang</th><th>Joueur</th><th>Score</th><th>Bonnes r√©p.</th><th>Temps moy.</th></tr>';
                
                ranking.forEach(player => {
                    log(`   ${player.rank}. ${player.name} - ${player.score} pts (${player.correctAnswers} bonnes r√©ponses, ${player.avgResponseTime}ms en moyenne)`, 'info');
                    tableHTML += `<tr>
                        <td><strong>${player.rank}</strong></td>
                        <td>${player.name} (${player.buzzerID})</td>
                        <td><strong>${player.score}</strong></td>
                        <td>${player.correctAnswers}</td>
                        <td>${player.avgResponseTime} ms</td>
                    </tr>`;
                });
                
                tableHTML += '</table>';
                resultsDiv.innerHTML = tableHTML;
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // 9. Obtenir les statistiques
        async function getStats() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/games/${currentGameId}/stats`);
                const stats = await response.json();
                
                log('üìä Statistiques de la partie :', 'success');
                
                const resultsDiv = document.getElementById('results');
                let html = '';
                
                stats.forEach(stat => {
                    const accuracy = ((stat.correct_answers / stat.total_answers) * 100).toFixed(1);
                    
                    html += `<div class="stat-card">
                        <h3>${stat.buzzer_id}</h3>
                        <p><strong>R√©ponses totales :</strong> ${stat.total_answers}</p>
                        <p><strong>Bonnes r√©ponses :</strong> ${stat.correct_answers} (${accuracy}%)</p>
                        <p><strong>Points :</strong> ${stat.total_points}</p>
                        <p><strong>Temps moyen :</strong> ${Math.round(stat.avg_response_time)} ms</p>
                        <p><strong>Temps min :</strong> ${Math.round(stat.min_response_time)} ms</p>
                        <p><strong>Temps max :</strong> ${Math.round(stat.max_response_time)} ms</p>
                    </div>`;
                    
                    log(`   ${stat.buzzer_id} : ${stat.total_answers} r√©ponses, ${stat.correct_answers} correctes (${accuracy}%), ${Math.round(stat.avg_response_time)}ms en moyenne`, 'info');
                });
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // 10. Informations de la partie
        async function getGameInfo() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/games/${currentGameId}`);
                const game = await response.json();
                
                log(`‚ÑπÔ∏è Informations de la partie :`, 'info');
                log(`   ID: ${game.id}`, 'info');
                log(`   Nom: ${game.name}`, 'info');
                log(`   Statut: ${game.status}`, 'info');
                log(`   Question actuelle: ${game.currentQuestionIndex + 1}/${game.totalQuestions}`, 'info');
                log(`   Joueurs: ${game.playerCount}`, 'info');
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // 11. Terminer la partie
        async function endGame() {
            if (!currentGameId) {
                log('‚ùå Cr√©ez d\'abord une partie', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/games/${currentGameId}/end`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`üèÅ Partie termin√©e √† ${new Date(data.endedAt).toLocaleTimeString()}`, 'success');
                } else {
                    log(`‚ùå Erreur : ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau : ${error.message}`, 'error');
            }
        }

        // Test complet automatis√©
        async function runFullTest() {
            log('üöÄ === D√âBUT DU TEST COMPLET ===', 'success');
            
            // 1. Charger les questions
            await loadQuestions();
            await new Promise(r => setTimeout(r, 500));
            
            // 2. Cr√©er la partie
            await createGame();
            await new Promise(r => setTimeout(r, 500));
            
            // 3. Ajouter les joueurs
            await addMultiplePlayers();
            await new Promise(r => setTimeout(r, 500));
            
            // 4. D√©marrer la partie
            await startGame();
            await new Promise(r => setTimeout(r, 500));
            
            // 5. Boucle sur toutes les questions
            for (let i = 0; i < selectedQuestionIds.length; i++) {
                log(`\nüìù === QUESTION ${i + 1}/${selectedQuestionIds.length} ===`, 'info');
                await getCurrentQuestion();
                await new Promise(r => setTimeout(r, 500));
                
                await simulateAnswers();
                await new Promise(r => setTimeout(r, 1000));
                
                await getRanking();
                await new Promise(r => setTimeout(r, 500));
                
                if (i < selectedQuestionIds.length - 1) {
                    await nextQuestion();
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            
            // 6. Terminer la partie
            await endGame();
            await new Promise(r => setTimeout(r, 500));
            
            // 7. Afficher les r√©sultats finaux
            log('\nüèÜ === R√âSULTATS FINAUX ===', 'success');
            await getRanking();
            await new Promise(r => setTimeout(r, 500));
            await getStats();
            
            log('\n‚úÖ === TEST COMPLET TERMIN√â ===', 'success');
        }

        // Charger les questions au d√©marrage
        window.onload = () => {
            log('üéÆ Application de test charg√©e', 'success');
            log('üìå Assurez-vous que le serveur tourne sur http://localhost:3000', 'info');
        };
    </script>
</body>
</html>